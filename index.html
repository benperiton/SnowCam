<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>SnowCam</title>
    <meta content="Tim Taubert" name="author">
    <link href="main.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="lib/webcam.js"></script>
    <script type="text/javascript" src="lib/snow.js"></script>
    <style>
    body {
    	background-color: #B1CEBA;
    }
	canvas, video {
		width: 320px;
		height: 240px;
	}
	.merge {
		position:absolute;
	}
    </style>
  </head>

  <body>
    <video id="camOriginal" width="320" height="240"></video>
    <canvas id="tmpCanvas" width="320" height="240"></canvas>
    <canvas id="camCanvas" width="320" height="240"></canvas>
    <canvas id="snowCanvas" width="320" height="240"></canvas>
    
    <script>
    	var
    		worker = new Worker( 'lib/wwCovolution.js' ),
    		tmpCanvas = document.getElementById( 'tmpCanvas' ),
    		tmpContext = tmpCanvas.getContext( '2d' ),
    		processedCanvas = document.getElementById( 'camCanvas' ),
    		processedContext = processedCanvas.getContext( '2d' )
		;
		
		webcam.init( 'camOriginal' )
		webcam.onReadFrame = function () {
			// Add current video frame to the temp canvas
			tmpContext.drawImage( webcam.video, 0, 0, webcam.width, webcam.height );
			
			// Post to a webworker so we don't block the snow updating
			worker.postMessage({
				'image': tmpContext.getImageData( 0, 0, webcam.width, webcam.height ),
				'horizontal': true,
				'vertical': false
			});
			
			
		};
		webcam.connect();
		
		// Once we have a result from the worker, update the processed canvas with the new frame
		worker.onmessage = function ($evt) {
			var
				imageData,
				i = 0,
				l = 0,
				edge,
				
				row = 0,
				col = 0,
				collectsOn = [];
			;
			
			imageData = tmpContext.createImageData( $evt.data.width, $evt.data.height );
			
			for ( i=0,l=imageData.data.length; i<l; i+=4 ) {
				// make the vertical gradient red
				if ( $evt.data.vertical ) {
					edge = Math.abs( $evt.data.vertical.data[i] );
					imageData.data[i] = edge;
				}

				// make the horizontal gradient green
				if ( $evt.data.horizontal ) {
					edge = Math.abs( $evt.data.horizontal.data[i] );
					imageData.data[i+1] = edge;
				}
				
				// Set row and col info for snow collection
				if ( i > 0 ) {
					col++;
				}
				
				if ( col % imageData.width == 0 ) {
					col = 0;
					row++;
				}
				
				if ( ! collectsOn[col] ) {
					collectsOn[col] = [];
				}
			
				// Only show pixles that could collect snow
				if ( imageData.data[i+1] > 100 ) {
					imageData.data[i+3] = 255;
					
					collectsOn[col][row] = 1;
					
				} else {
					imageData.data[i+3] = 0;
					
					collectsOn[col][row] = 0;
				}
			}
			
			snow.ledges = collectsOn;
			//console.log(collectsOn);
			
			processedContext.putImageData( imageData, 0, 0 );
			
			window.mozRequestAnimationFrame( webcam.onReadFrame );
	    };
	    
	    // Start the snow on a seperate canvas
		snow.init( 'snowCanvas' );
		
		function merge () {
			var
				c = document.getElementsByTagName( 'canvas' )
				v = document.getElementsByTagName( 'video' ),
				i = 0,
				l = 0
			;
			
			for ( i=0,l=c.length; i<l; i++ ) {
				if ( c[i].style.position == 'absolute' ) {
					c[i].style.position = 'relative';
					
				} else {
					c[i].style.position = 'absolute';
				}
			}
			
			for ( i=0,l=v.length; i<l; i++ ) {
				if ( v[i].style.position == 'absolute' ) {
					v[i].style.position = 'relative';
					
				} else {
					v[i].style.position = 'absolute';
				}
			}
		}
    </script>
    <button onclick="merge()" style="position:relative">(Un)Merge</button>
  </body>
</html>
